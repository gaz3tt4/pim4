<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark" class="h-100">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vendas</title>

    <!-- Referencia para os estilos do CDN Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Referencia para os estilos do Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />

    <!-- Referencia para os estilos de fonte do google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet" />

    <style>
      .fazendola-text {
        /* Ajuste do texto escrito na navbar */
        font-family: 'Itim', cursive;
        font-weight: 400;
        font-style: normal;
        color: #ffffff;
      }
    </style>
  </head>

  <body>
    <nav class="navbar bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'index' %}">
          <img src="assets/FarmVille Logo sem fundo.png" alt="Logo" width="40" height="34" class="d-inline-block align-text-top" />
          <span class="fazendola-text">Fazendola</span>
        </a>
        <span class="navbar-text ms-auto d-flex align-items-center">
          <i class="fa-solid fa-circle-user" style="color: #ffffff; font-size: 1.5rem; margin-right: 0.5rem;"></i>
          <!-- Ajuste o tamanho do ícone aqui -->
          <span style="color: #ffffff; font-size: 1.2rem;">Fazendeiro ADMIN</span>
          <!-- Ajuste o tamanho do texto aqui -->
        </span>
      </div>
    </nav>
    <br />

    <section class="py-4 container">
      <form id="formVenda" class="row g-3" method="post" action="{% url 'salvarVenda' %}">
      <h3 class="fw-bold p-3">Vendas</h3>
      <div class="row">
        <div class="col-md-2">
          <label for="inputNome4" class="form-label">Cliente</label>
          <select name="IdCliente" class="form-control" id="slectProd" required>
            {% for cliente in clientes %}
              <option value="{{ cliente.cli_in_id }}">{{ cliente.cli_st_nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="inputDate" class="form-label">Data da Venda</label>
          <input type="date" class="form-control" id="inputDate" name="DataCompra" required />
        </div>
      </div>
    </section>

    <section class="py-4 container">
      <div class="row">
        <div class="border border-2 rounded p-4">
                {% csrf_token %}

                <div id="itensVenda">
                    <div class="row g-3 align-items-center venda-item">
                      <div class="col-md-2">
                        <label for="inputNome4" class="form-label">Produto</label>
                        <select name="Produto[]" class="form-control">
                          {% for compra in lista_estoque %}
                          <option value="{{ compra.comp_in_id }}|{{ compra.comp_in_idProduto.id }}">{{ compra.comp_in_idProduto.est_st_nome }}#{{ compra.comp_in_id }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-md-2">
                        <label for="inputAddress" class="form-label">Quantidade</label>
                        <input type="number" class="form-control Quantidade" placeholder="10kg" name="Quantidade[]" />
                      </div>
                      <div class="col-md-2">
                        <label for="inputTel2" class="form-label">Valor</label>
                        <input type="text" class="form-control Preco" placeholder="R$10,00" name="Preco[]" />
                      </div>
                      <div class="col-md-1 d-flex align-items-center">
                        <button type="button" class="btn btn-danger excluir-item" style="margin-top: 30px;">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 mt-3 text-end">
                    <label for="valorTotal" class="form-label fw-bold">Valor Total:</label>
                    <span id="valorTotal" class="fw-bold">R$0,00</span>
                  </div>
                
                  <div class="col-12 mt-3">
                    <button id="btnVoltar" type="button" class="btn btn-outline-primary">
                      <i class="fa-solid fa-arrow-left"></i> Voltar
                    </button>
                    <button type="submit" class="btn btn-outline-primary">
                      <i class="fa-regular fa-floppy-disk"></i> Salvar
                    </button>
                    <button id="btnAdicionarVenda" type="button" class="btn btn-outline-primary">
                      <i class="fa-regular fa-plus"></i> Adicionar
                    </button>
                  </div>
                </form>


              {% comment %} <script>
                            // Captura o botão pelo ID e adiciona o evento de clique
                            document.getElementById('btnVoltar').addEventListener('click', function () {
                                window.location.href = "{% url 'Store' %}";
                            });
                        </script> {% endcomment %}
            </div>
          </form>
        </div>
      </div>
    </section>

    <script>

        function excluirItem(event) {
            const item = event.target.closest('.venda-item'); // Encontrar o item mais próximo do botão
            if (item) {
              item.remove(); // Remover o item
              atualizarValorTotal(); // Recalcular o total após a exclusão
            }
          }
          
          // Adicionando o evento de clique ao botão de excluir
          document.addEventListener('click', function (event) {
            if (event.target.classList.contains('excluir-item')) {
              excluirItem(event);
            }
          });
          
          // Função para atualizar o valor total (já existe no seu código)
          function atualizarValorTotal() {
            let total = 0;
          
            // Itera sobre todos os itens e calcula o total
            document.querySelectorAll('.venda-item').forEach(item => {
              const quantidade = parseFloat(item.querySelector('.Quantidade').value) || 0;
              const preco = parseFloat(item.querySelector('.Preco').value.replace('R$', '').replace(',', '.')) || 0;
              total += quantidade * preco;
            });
          
            // Atualiza a label de valor total
            document.getElementById('valorTotal').textContent = `R$${total.toFixed(2).replace('.', ',')}`;
          }
          
          // Garantir que os campos de quantidade e preço disparem o cálculo quando alterados
          document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.Quantidade, .Preco').forEach(input => {
              input.addEventListener('input', atualizarValorTotal);
            });
          });
          
          document.getElementById('btnAdicionarVenda').addEventListener('click', function () {
            const itensVenda = document.getElementById('itensVenda');
            const novaLinha = document.querySelector('.venda-item').cloneNode(true);
          
            // Limpa os campos da nova linha clonada
            novaLinha.querySelectorAll('input, select').forEach(input => {
              if (input.tagName === "INPUT") {
                input.value = "";
              }
            });
          
            // Adiciona a nova linha ao container
            itensVenda.appendChild(novaLinha);
          
            // Adiciona o evento de input para os novos campos
            novaLinha.querySelectorAll('.Quantidade, .Preco').forEach(input => {
              input.addEventListener('input', atualizarValorTotal);
            });
          
            // Adiciona o evento de excluir no botão
            novaLinha.querySelector('.excluir-item').addEventListener('click', excluirItem);
          
            atualizarValorTotal(); // Atualiza o total imediatamente
          });
          
          document.getElementById('btnVoltar').addEventListener('click', function () {
            window.location.href = "{% url 'index' %}";
          });
      </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>
</html>
